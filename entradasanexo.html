<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Importar Resumo de Vendas</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;padding:20px;background:#0b0b0b;color:#fff;font-family:Inter}
.card{background:#151515;border:1px solid #242424;border-radius:18px;padding:16px;margin-bottom:16px}
input,button{width:100%;padding:12px;border-radius:12px;border:1px solid #242424;background:#0b0b0b;color:#fff}
button{background:#d4af37;color:#000;font-weight:800;cursor:pointer}
.preview{font-size:13px;color:#cbd5f5;line-height:1.6}
.file-box{border-top:1px dashed #333;padding-top:12px;margin-top:12px}
.success{color:#22c55e}
.error{color:#ef4444}
</style>
</head>

<body>

<div class="card">
  <h2>Importar Resumo de Vendas</h2>

  <input type="file" id="files" accept=".xls,.xlsx" multiple><br><br>

  <label>Data do lançamento</label>
  <input type="date" id="data"><br><br>

  <button onclick="processarArquivos()">Processar Arquivos</button>
</div>

<div class="card">
  <h3>Pré-visualização</h3>
  <div id="preview" class="preview">Nenhum arquivo processado.</div>
</div>

<div class="card">
  <button onclick="salvarTudo()">Salvar no Sistema</button>
  <div id="msg"></div>
</div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://dxkszikemntfusfyrzos.supabase.co";
const SUPABASE_KEY = "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= DATA PADRÃO = ONTEM ================= */
(() => {
  const d = new Date();
  d.setDate(d.getDate() - 1);
  document.getElementById("data").value = d.toISOString().split("T")[0];
})();

/* ================= MAPA DE MODALIDADES ================= */
const categoriasAgrupadas = {
  "CRÉDITO": ["credito", "cartao credito", "credito tef", "credito pos", "credito delivery"],
  "DÉBITO": ["debito", "cartao debito", "debito tef", "debito pos"],
  "PIX": ["pix", "pix tef", "pix pos", "qrcode", "pix cnpj"],
  "DINHEIRO": ["dinheiro"],
  "ONLINE": ["online", "pgto online"],
  "CONSUMO INTERNO": ["consumo", "funcionario"],
  "VOUCHER": ["voucher"],
  "CREDIÁRIO": ["crediario"],
  "OUTROS": []
};

const normalize = s =>
  (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();

function agruparModalidade(txt){
  const n = normalize(txt);
  for(const cat in categoriasAgrupadas){
    if(categoriasAgrupadas[cat].some(v=>n.includes(v))) return cat;
  }
  return "OUTROS";
}

/* ================= VAR ================= */
let registros = [];

/* ================= PROCESSAR ================= */
async function processarArquivos(){
  const files = document.getElementById("files").files;
  const data = document.getElementById("data").value;
  const preview = document.getElementById("preview");

  if(!files.length || !data){
    alert("Selecione arquivos e data");
    return;
  }

  registros = [];
  preview.innerHTML = "";

  for(const file of files){
    await processarArquivo(file, data, preview);
  }
}

function processarArquivo(file, data, preview){
  return new Promise(resolve=>{
    const reader = new FileReader();

    reader.onload = e => {
      const wb = XLSX.read(e.target.result,{type:"binary"});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws,{header:1});

      let empresaDetectada = detectarEmpresaNormal(rows);
      let caixaAtual = null;

      const buffer = [];

      rows.forEach(l=>{
        const col0 = l[0];
        const desc = l[1];
        const valRaw = l[2];

        if(typeof col0 === "string" && col0.toLowerCase().includes("caixa")){
          caixaAtual = parseInt(col0.replace(/\D/g,""));
          return;
        }

        const valor = Number(String(valRaw).replace(".","").replace(",","."));
        if(!desc || valor <= 0) return;

        let empresaFinal = empresaDetectada;

        // REGRA MERCATTO
        if(!empresaDetectada){
          if(!caixaAtual) return;
          empresaFinal = caixaAtual <= 5
            ? "EMPORIO MERCATTO"
            : "RESTAURANTE MERCATTO";
        }

        buffer.push({
          data_lancamento: data,
          empresa: empresaFinal,
          caixa: caixaAtual,
          modalidade: agruparModalidade(desc),
          valor,
          origem: "IMPORTACAO_EXCEL",
          arquivo_origem: file.name
        });
      });

      registros.push(...buffer);

      const agrupado = {};
      buffer.forEach(r=>{
        const k = `${r.empresa}_${r.modalidade}`;
        agrupado[k] = (agrupado[k]||0) + r.valor;
      });

      preview.innerHTML += `
        <div class="file-box">
          <strong>Arquivo:</strong> ${file.name}<br>
          ${Object.entries(agrupado).map(([k,v])=>{
            const [emp,mod] = k.split("_");
            return `• ${emp} — ${mod}: R$ ${v.toFixed(2)}`;
          }).join("<br>")}
        </div>
      `;

      resolve();
    };

    reader.readAsBinaryString(file);
  });
}

function detectarEmpresaNormal(rows){
  const linha = rows.find(r =>
    typeof r[0] === "string" &&
    r[0].toLowerCase().includes("loja")
  );
  if(!linha) return null;
  return linha[0].split(":").pop().trim().toUpperCase();
}

/* ================= SALVAR ================= */
async function salvarTudo(){
  if(!registros.length){
    alert("Nada para salvar");
    return;
  }

  const { error } = await sb.from("resumo_entradas").insert(registros);

  document.getElementById("msg").innerHTML = error
    ? `<div class="error">Erro ao salvar</div>`
    : `<div class="success">Importação concluída com sucesso</div>`;
}
</script>

</body>
</html>
