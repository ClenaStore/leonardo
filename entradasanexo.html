<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Importar Vendas</title>

<meta name="viewport"
      content="width=device-width, initial-scale=1,
               maximum-scale=1, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  padding:20px;
  background:#0b0b0b;
  color:#fff;
  font-family:Inter;
}
.card{
  background:#151515;
  border:1px solid #242424;
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}
input,button{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #242424;
  background:#0b0b0b;
  color:#fff;
}
button{
  background:#d4af37;
  color:#000;
  font-weight:800;
  cursor:pointer;
}
.list{
  font-size:13px;
  color:#cbd5f5;
}
.success{color:#22c55e}
.error{color:#ef4444}
</style>
</head>

<body>

<div class="card">
  <h2>Importar Resumo de Vendas</h2>

  <input type="file" id="file" accept=".xls,.xlsx">
  <br><br>

  <label>Data do lançamento</label>
  <input type="date" id="data">

  <br><br>
  <button onclick="processar()">Processar Arquivo</button>
</div>

<div class="card">
  <h3>Pré-visualização</h3>
  <div id="preview" class="list"></div>
</div>

<div class="card">
  <button onclick="salvar()">Salvar no Sistema</button>
  <div id="msg"></div>
</div>

<script>
const SUPABASE_URL = "https://dxkszikemntfusfyrzos.supabase.co";
const SUPABASE_KEY = "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let registros = [];
let empresaDetectada = "";

function processar(){
  const file = document.getElementById("file").files[0];
  const data = document.getElementById("data").value;
  if(!file || !data){
    alert("Selecione o arquivo e a data");
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, {type:"binary"});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, {header:1});

    // Detecta empresa
    const lojaLinha = rows.find(r => String(r[0]||"").includes("Loja:"));
    empresaDetectada = lojaLinha
      ? lojaLinha[0].split("Loja:")[1].trim()
      : "DESCONHECIDA";

    registros = [];

    rows.forEach(r=>{
      const formato = r[1];
      const total = parseFloat(String(r[2]).replace(",","."));

      if(typeof formato === "string" && formato.includes("-") && total > 0){
        registros.push({
          empresa: empresaDetectada,
          data,
          modalidade: formato.split("-")[1].trim(),
          valor: total,
          origem: "IMPORTACAO_EXCEL"
        });
      }
    });

    preview.innerHTML = `
      <strong>Empresa:</strong> ${empresaDetectada}<br><br>
      ${registros.map(r=>`• ${r.modalidade}: R$ ${r.valor.toFixed(2)}`).join("<br>")}
    `;
  };

  reader.readAsBinaryString(file);
}

async function salvar(){
  if(!registros.length) return;

  const { error } = await sb.from("resumo_entradas").insert(registros);

  if(error){
    msg.innerHTML = `<div class="error">Erro ao salvar</div>`;
    console.error(error);
  }else{
    msg.innerHTML = `<div class="success">Importação concluída com sucesso</div>`;
  }
}
</script>

</body>
</html>
