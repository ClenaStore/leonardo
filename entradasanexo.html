<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Importar Resumo de Vendas</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;padding:20px;background:#0b0b0b;color:#fff;font-family:Inter}
.card{background:#151515;border:1px solid #242424;border-radius:16px;padding:16px;margin-bottom:16px}
input,button{width:100%;padding:12px;border-radius:12px;border:1px solid #242424;background:#0b0b0b;color:#fff}
button{background:#d4af37;color:#000;font-weight:800;cursor:pointer}
.preview{font-size:13px;color:#cbd5f5;line-height:1.5}
.success{color:#22c55e}
.error{color:#ef4444}
</style>
</head>

<body>

<div class="card">
  <h2>Importar Resumo de Vendas</h2>
  <input type="file" id="file" accept=".xls,.xlsx"><br><br>

  <label>Data do lan√ßamento</label>
  <input type="date" id="data"><br><br>

  <button onclick="processar()">Processar Arquivo</button>
</div>

<div class="card">
  <h3>Pr√©-visualiza√ß√£o</h3>
  <div id="preview" class="preview">Nenhum arquivo processado.</div>
</div>

<div class="card">
  <button onclick="salvar()">Salvar no Sistema</button>
  <div id="msg"></div>
</div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://dxkszikemntfusfyrzos.supabase.co";
const SUPABASE_KEY = "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= AGRUPAMENTO ================= */
const categoriasAgrupadas = {
  "CR√âDITO": ["credito", "cartao credito", "credito pos", "credito tef", "cart credito"],
  "D√âBITO": ["debito", "cartao debito", "debito pos", "debito tef"],
  "PIX": ["pix", "pix tef", "pix pos", "qrcode"],
  "DINHEIRO": ["dinheiro"],
  "CREDI√ÅRIO": ["crediario", "crediario clientes"],
  "VOUCHER": ["voucher"],
  "ONLINE": ["pagamento online"],
  "OUTROS": []
};

/* ================= UTIL ================= */
const normalize = s =>
  (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();

function agruparModalidade(nome){
  const n = normalize(nome);
  for(const grupo in categoriasAgrupadas){
    if(categoriasAgrupadas[grupo].some(v => n.includes(v))) return grupo;
  }
  return "OUTROS";
}

/* ================= VARI√ÅVEIS ================= */
let registros = [];
let empresaDetectada = "";

/* ================= PROCESSAR ================= */
function processar(){
  const file = file.files[0];
  const data = document.getElementById("data").value;
  if(!file || !data){ alert("Selecione arquivo e data"); return; }

  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result,{type:"binary"});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws,{header:1});

    registros = [];
    empresaDetectada = "DESCONHECIDA";

    // üîç Detecta empresa (robusto)
    rows.flat().forEach(cell=>{
      if(typeof cell === "string" && normalize(cell).includes("loja")){
        empresaDetectada = cell.split("-").slice(1).join("-").trim() || cell.trim();
      }
    });

    // üìä Processa vendas
    rows.forEach(r=>{
      const forma = r[1];
      const valor = Number(String(r[2]).replace(",","."));
      if(typeof forma === "string" && valor > 0){
        const modalidade = agruparModalidade(forma);
        registros.push({
          empresa: empresaDetectada,
          data,
          modalidade,
          valor,
          origem: "IMPORTACAO_EXCEL"
        });
      }
    });

    preview.innerHTML = `<strong>Empresa:</strong> ${empresaDetectada}<br><br>` +
      registros.map(r=>`‚Ä¢ ${r.modalidade}: R$ ${r.valor.toFixed(2)}`).join("<br>");
  };
  reader.readAsBinaryString(file);
}

/* ================= SALVAR ================= */
async function salvar(){
  if(!registros.length){ alert("Nada para salvar"); return; }
  const { error } = await sb.from("resumo_entradas").insert(registros);
  msg.innerHTML = error
    ? `<div class="error">Erro ao salvar</div>`
    : `<div class="success">Importa√ß√£o conclu√≠da</div>`;
}
</script>

</body>
</html>
