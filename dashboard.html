<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard Financeiro • Entradas</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0b0b0b;
  --card:#151515;
  --border:#242424;
  --gold:#d4af37;
  --green:#22c55e;
  --text:#f5f5f5;
  --muted:#9ca3af;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
html,body{
  width:100%;height:100%;
  background:var(--bg);color:var(--text);
  overflow:auto;scrollbar-width:none
}
body::-webkit-scrollbar{display:none}
.header{padding:16px}
.header h2{font-size:18px;font-weight:800}
.header span{font-size:12px;color:var(--muted)}
.filters{padding:0 16px 16px;display:flex;flex-direction:column;gap:10px}
select,input{
  padding:12px;border-radius:12px;
  background:#0b0b0b;border:1px solid var(--border);
  color:var(--text)
}
.chart-box,.card{
  margin:0 16px 16px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px
}
.cards{display:grid;gap:12px}
.value{font-size:22px;font-weight:800}
.total{color:var(--gold)}
.entrada{color:var(--green)}
.info{font-size:12px;color:var(--muted)}
</style>
</head>

<body>

<div class="header">
  <h2>Dashboard Financeiro</h2>
  <span id="periodoLabel">—</span>
</div>

<div class="filters">
  <select id="empresa"></select>
  <input id="periodo" placeholder="Período (dd/mm/aaaa)">
</div>

<div class="chart-box">
  <canvas id="grafico" height="180"></canvas>
</div>

<div class="cards">
  <div class="card">
    <div class="info">Entradas Financeiras</div>
    <div class="value entrada" id="totalEntradas">R$ 0,00</div>
  </div>

  <div class="card">
    <div class="info">Ticket Médio Diário</div>
    <div class="value total" id="ticketMedio">R$ 0,00</div>
  </div>

  <div class="card">
    <div class="info">Modalidades não financeiras</div>
    <div id="informativas" class="info">—</div>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

/* ================= CONFIG ================= */
const MODALIDADES_NAO_FINANCEIRAS = [
  "CONSUMO INTERNO",
  "BONIFICAÇÃO"
];

/* ================= DATA PADRÃO = ONTEM (LOCAL) ================= */
function ontemISO(){
  const d = new Date();
  d.setHours(12,0,0,0);
  d.setDate(d.getDate() - 1);

  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");

  return `${yyyy}-${mm}-${dd}`;
}

let dataInicio = localStorage.getItem("DATA_INICIO") || ontemISO();
let dataFim = localStorage.getItem("DATA_FIM") || ontemISO();

localStorage.setItem("DATA_INICIO", dataInicio);
localStorage.setItem("DATA_FIM", dataFim);

periodoLabel.innerText =
  new Date(dataInicio + "T12:00").toLocaleDateString("pt-BR");

/* ================= EMPRESAS ================= */
async function carregarEmpresas(){
  const { data } = await sb
    .from("resumo_entradas")
    .select("empresa", { distinct:true });

  const select = document.getElementById("empresa");
  select.innerHTML = `<option value="todas">Todas as empresas</option>`;

  [...new Set(data.map(d=>d.empresa))].forEach(e=>{
    const opt = document.createElement("option");
    opt.value = e;
    opt.textContent = e;
    select.appendChild(opt);
  });

  select.value = localStorage.getItem("EMPRESA_ATIVA") || "todas";

  select.onchange = ()=>{
    localStorage.setItem("EMPRESA_ATIVA", select.value);
    carregarDados();
  };
}

/* ================= CALENDÁRIO ================= */
flatpickr("#periodo",{
  mode:"range",
  dateFormat:"d/m/Y",
  locale:flatpickr.l10ns.pt,
  defaultDate:[
    new Date(dataInicio+"T12:00"),
    new Date(dataFim+"T12:00")
  ],
  onClose:(d)=>{
    if(d.length===2){
      dataInicio = d[0].toISOString().slice(0,10);
      dataFim = d[1].toISOString().slice(0,10);

      localStorage.setItem("DATA_INICIO",dataInicio);
      localStorage.setItem("DATA_FIM",dataFim);

      periodoLabel.innerText =
        d[0].toLocaleDateString("pt-BR")+" a "+
        d[1].toLocaleDateString("pt-BR");

      carregarDados();
    }
  }
});

/* ================= DADOS ================= */
let chart;

async function carregarDados(){
  let q = sb.from("resumo_entradas").select("*").order("data_lancamento");

  const emp = localStorage.getItem("EMPRESA_ATIVA");
  if(emp && emp!=="todas") q = q.eq("empresa",emp);

  q = q.gte("data_lancamento", dataInicio)
       .lte("data_lancamento", dataFim);

  const { data } = await q;
  montarDashboard(data||[]);
}

/* ================= DASHBOARD ================= */
function montarDashboard(lista){
  let total = 0;
  const porDia = {};
  const informativas = {};

  lista.forEach(r=>{
    if(MODALIDADES_NAO_FINANCEIRAS.includes(r.modalidade)){
      informativas[r.modalidade] =
        (informativas[r.modalidade]||0)+Number(r.valor);
      return;
    }

    total += Number(r.valor);

    porDia[r.data_lancamento] =
      (porDia[r.data_lancamento]||0)+Number(r.valor);
  });

  const diasUnicos = Object.keys(porDia).length;

  totalEntradas.innerText =
    `R$ ${total.toLocaleString("pt-BR",{minimumFractionDigits:2})}`;

  ticketMedio.innerText =
    diasUnicos
      ? `R$ ${(total/diasUnicos).toLocaleString("pt-BR",{minimumFractionDigits:2})}`
      : "R$ 0,00";

  informativas.innerHTML = Object.entries(informativas)
    .map(([m,v])=>`${m}: R$ ${v.toLocaleString("pt-BR",{minimumFractionDigits:2})}`)
    .join("<br>") || "—";

  const labels = Object.keys(porDia).map(d=>d.split("-").reverse().join("/"));
  const valores = Object.values(porDia);

  if(chart) chart.destroy();
  chart = new Chart(grafico,{
    type:"line",
    data:{labels,datasets:[{
      data:valores,
      borderColor:"#22c55e",
      backgroundColor:"rgba(34,197,94,.15)",
      tension:.4
    }]},
    options:{plugins:{legend:{display:false}}}
  });
}

/* INIT */
carregarEmpresas().then(carregarDados);
</script>

</body>
</html>
