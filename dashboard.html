<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard Financeiro ‚Ä¢ Entradas</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0b0b0b;
  --card:#151515;
  --border:#242424;
  --gold:#d4af37;
  --green:#22c55e;
  --text:#f5f5f5;
  --muted:#9ca3af;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
html,body{
  width:100%;height:100%;
  background:var(--bg);color:var(--text);
  overflow:auto;scrollbar-width:none
}
body::-webkit-scrollbar{display:none}

.header{padding:16px}
.header h2{font-size:18px;font-weight:800}
.header span{font-size:12px;color:var(--muted)}

/* ===== FILTROS ===== */
.filters{
  padding:0 16px 16px;
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

.filters select,
.filters input{
  flex:1;
  min-width:140px;
  padding:12px;
  border-radius:12px;
  background:#0b0b0b;
  border:1px solid var(--border);
  color:var(--text);
}

.btn-limpar{
  padding:0 12px;
  height:44px;
  border-radius:12px;
  border:1px dashed var(--border);
  background:transparent;
  color:var(--muted);
  font-size:12px;
  cursor:pointer;
}

.btn-limpar:hover{
  color:#fff;
  border-color:#444;
}

/* ===== GR√ÅFICO E CARDS ===== */
.chart-box,.card{
  margin:0 16px 16px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px
}

.cards{display:grid;gap:12px}
.value{font-size:22px;font-weight:800}
.total{color:var(--gold)}
.entrada{color:var(--green)}
.info{font-size:12px;color:var(--muted)}
  /* ===== METAS ===== */
.card canvas{
  max-height:180px;
}
/* ================= METAS ‚Äì AJUSTE MOBILE PERFEITO ================= */

/* Container das metas */
.cards[style*="grid-template-columns:1fr 1fr"]{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin:0 16px 16px;
}

/* Remove margem lateral dos cards s√≥ nas metas */
.cards[style*="grid-template-columns:1fr 1fr"] .card{
  margin:0;
  padding:12px;
}

/* Canvas nunca estoura */
.cards[style*="grid-template-columns:1fr 1fr"] canvas{
  max-width:100%;
  height:auto;
}

/* ===== MOBILE ===== */
@media (max-width: 640px){

  /* Continua 2 colunas */
  .cards[style*="grid-template-columns:1fr 1fr"]{
    grid-template-columns:1fr 1fr;
    margin:0 12px 16px;
  }

  /* Card ainda mais compacto */
  .cards[style*="grid-template-columns:1fr 1fr"] .card{
    padding:10px;
    border-radius:16px;
  }

  /* Donut menor para caber */
  .cards[style*="grid-template-columns:1fr 1fr"] canvas{
    max-height:120px;
  }

  /* Texto menor */
  .cards[style*="grid-template-columns:1fr 1fr"] .info{
    font-size:11px;
    text-align:center;
  }
}

</style>
</head>

<body>

<div class="header">
  <h2>Dashboard Financeiro</h2>
  <span id="periodoLabel">‚Äî</span>
</div>

<!-- FILTROS EM LINHA -->
<div class="filters">
  <select id="empresa"></select>
  <input id="periodo" placeholder="Per√≠odo (dd/mm/aaaa)">
  <button class="btn-limpar" onclick="limparFiltros()">Limpar</button>
</div>

<div class="chart-box">
  <canvas id="grafico" height="180"></canvas>
</div>
<div class="cards" style="grid-template-columns:1fr 1fr">
  <div class="card">
    <div class="info">Meta Prata</div>
    <canvas id="metaPrata" height="180"></canvas>
  </div>

  <div class="card">
    <div class="info">Meta Ouro</div>
    <canvas id="metaOuro" height="180"></canvas>
  </div>
</div>

<div class="cards">
  <div class="card">
    <div class="info">Entradas Financeiras</div>
    <div class="value entrada" id="totalEntradas">R$ 0,00</div>
  </div>

  <div class="card">
    <div class="info">Ticket M√©dio Di√°rio</div>
    <div class="value total" id="ticketMedio">R$ 0,00</div>
  </div>

  <div class="card">
    <div class="info">Modalidades n√£o financeiras</div>
    <div id="informativas" class="info">‚Äî</div>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

/* ================= CONFIG ================= */
const MODALIDADES_NAO_FINANCEIRAS = [
  "BONIFICA",
  "ERRO",
  "SEM FATURAMENTO",
  "S√ìCIO",
  "SOCIO",
  "CONV√äNIO",
  "CONVENIO"
];
/* ================= METAS POR EMPRESA ================= */
const METAS = {
  "DELICIA GOURMET": { prata: 80000, ouro: 120000 },
  "EMPORIO MERCATTO": { prata: 100000, ouro: 150000 },
  "MEOS GOURMET LTDA": { prata: 60000, ouro: 90000 },
  "PANIFICADORA DELICIA": { prata: 50000, ouro: 80000 },
  "RESTAURANTE MERCATTO": { prata: 120000, ouro: 180000 },
  "M. KIDS": { prata: 30000, ouro: 50000 }
};

/* ================= UTIL ================= */
const limparNomeEmpresa = n =>

  function obterMesReferencia(dataInicio, dataFim){
  const ini = new Date(dataInicio);
  const fim = new Date(dataFim);

  // Se cruzou meses, usa o m√™s mais recente
  if(
    ini.getMonth() !== fim.getMonth() ||
    ini.getFullYear() !== fim.getFullYear()
  ){
    return {
      ano: fim.getFullYear(),
      mes: fim.getMonth() + 1
    };
  }

  // Mesmo m√™s
  return {
    ano: ini.getFullYear(),
    mes: ini.getMonth() + 1
  };
}

  n
   .replace(/^\d+\s*-\s*/,"")
   .normalize("NFD")
   .replace(/[\u0300-\u036f]/g,"")
   .toUpperCase()
   .trim();

/* ================= DATA PADR√ÉO = ONTEM ================= */
function ontemISO(){
  const d = new Date();
  d.setHours(12,0,0,0);
  d.setDate(d.getDate() - 1);
  return d.toISOString().slice(0,10);
}

let dataInicio = localStorage.getItem("DATA_INICIO") || ontemISO();
let dataFim = localStorage.getItem("DATA_FIM") || ontemISO();

localStorage.setItem("DATA_INICIO",dataInicio);
localStorage.setItem("DATA_FIM",dataFim);

periodoLabel.innerText =
  new Date(dataInicio+"T12:00").toLocaleDateString("pt-BR");

/* ================= EMPRESAS ================= */
async function carregarEmpresas(){
  const { data } = await sb.from("resumo_entradas").select("empresa");

  const select = empresa;
  select.innerHTML = `<option value="todas">Todas as empresas</option>`;

  [...new Set(data.map(d=>d.empresa))].forEach(e=>{
    const o = document.createElement("option");
    o.value = e;
    o.textContent = limparNomeEmpresa(e);
    select.appendChild(o);
  });

  select.value = localStorage.getItem("EMPRESA_ATIVA") || "todas";

  select.onchange = ()=>{
    localStorage.setItem("EMPRESA_ATIVA",select.value);
    carregarDados();
  };
}

/* ================= CALEND√ÅRIO ================= */
const picker = flatpickr("#periodo",{
  mode:"range",
  dateFormat:"d/m/Y",
  locale:flatpickr.l10ns.pt,
  defaultDate:[
    new Date(dataInicio+"T12:00"),
    new Date(dataFim+"T12:00")
  ],
  onClose:(d)=>{
    if(d.length===2){
      dataInicio = d[0].toISOString().slice(0,10);
      dataFim = d[1].toISOString().slice(0,10);
      localStorage.setItem("DATA_INICIO",dataInicio);
      localStorage.setItem("DATA_FIM",dataFim);
      periodoLabel.innerText =
        d[0].toLocaleDateString("pt-BR")+" a "+
        d[1].toLocaleDateString("pt-BR");
      carregarDados();
    }
  }
});

/* ================= LIMPAR ================= */
function limparFiltros(){
  localStorage.removeItem("EMPRESA_ATIVA");
  localStorage.removeItem("DATA_INICIO");
  localStorage.removeItem("DATA_FIM");

  dataInicio = ontemISO();
  dataFim = ontemISO();

  picker.setDate([
    new Date(dataInicio+"T12:00"),
    new Date(dataFim+"T12:00")
  ], true);

  periodoLabel.innerText =
    new Date(dataInicio+"T12:00").toLocaleDateString("pt-BR");

  empresa.value = "todas";
  carregarDados();
}

/* ================= DADOS ================= */
let chart;
/* ================= TEXTO CENTRAL DONUT ================= */
const textoCentro = {
  id: 'textoCentro',
  afterDraw(chart){
    const {ctx} = chart;
    const v = chart.config.data.valor;
    const p = chart.config.data.percentual;

    ctx.save();
    ctx.font = "700 16px Inter";
    ctx.fillStyle = "#fff";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(
      `R$ ${v.toLocaleString("pt-BR",{minimumFractionDigits:2})}`,
      chart.width/2,
      chart.height/2 - 8
    );

    ctx.font = "12px Inter";
    ctx.fillStyle = "#9ca3af";
    ctx.fillText(
      `${p}% da meta`,
      chart.width/2,
      chart.height/2 + 12
    );
  }
};

async function carregarDados(){
  let todos = [];
  let from = 0;
  const step = 1000;

  while(true){
let q = sb
  .from("resumo_entradas")
  .select("*")
  .order("data_lancamento", { ascending: true })
  .order("id", { ascending: true })
  .range(from, from + step - 1);


    const emp = localStorage.getItem("EMPRESA_ATIVA");
    if(emp && emp !== "todas") q = q.eq("empresa", emp);

    q = q
      .gte("data_lancamento", dataInicio)
      .lte("data_lancamento", dataFim);

    const { data } = await q;
    if(!data || !data.length) break;

    todos.push(...data);
    from += step;
  }

  montarDashboard(todos);
}
/* ================= METAS ================= */
async function calcularFaturamentoMeta(){
  const emp = empresa.value;

  const { ano, mes } = obterMesReferencia(dataInicio, dataFim);

  let inicio = `${ano}-${String(mes).padStart(2,"0")}-01`;
  let fim = new Date(ano, mes, 0).toISOString().slice(0,10);

  let total = 0;
  let from = 0;
  const step = 1000;

  while(true){
    let q = sb
      .from("resumo_entradas")
      .select("valor, modalidade")
      .gte("data_lancamento", inicio)
      .lte("data_lancamento", fim)
      .range(from, from + step - 1);

    if(emp && emp !== "todas"){
      q = q.eq("empresa", emp);
    }

    const { data } = await q;
    if(!data || !data.length) break;

    data.forEach(r=>{
      const mod = (r.modalidade||"").toUpperCase();
      if(MODALIDADES_NAO_FINANCEIRAS.some(n => mod.includes(n))) return;
      total += Number(r.valor) || 0;
    });

    from += step;
  }

  return total;
}
function calcularMeta(total, meta){
  const atingido = Math.min(total, meta);
  const restante = Math.max(meta - total, 0);
  return [atingido, restante];
}


function criarDonut(id, dados, cor, meta, total){
  const ctx = document.getElementById(id);
  if(!ctx) return;

  if(ctx.chart) ctx.chart.destroy();

  const percentual = Math.min(100, Math.round((total/meta)*100));

  ctx.chart = new Chart(ctx,{
    type:"doughnut",
    plugins:[textoCentro],
 data:{
  valor: Math.min(total, meta),
  percentual,

      datasets:[{
        data:dados,
        backgroundColor:[cor, "#242424"],
        borderWidth:0,
        cutout:"78%"
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      animation:{duration:900}
    }
  });
}

async function renderizarMetas(){
  const emp = empresa.value;

  let faturamento = await calcularFaturamentoMeta();

  let metaPrata = 0;
  let metaOuro = 0;

  if(emp === "todas"){
    Object.values(METAS).forEach(m=>{
      metaPrata += m.prata;
      metaOuro += m.ouro;
    });
  } else {
    const nome = limparNomeEmpresa(emp);
    const meta = METAS[nome];
    if(!meta) return;
    metaPrata = meta.prata;
    metaOuro = meta.ouro;
  }

  criarDonut(
    "metaPrata",
    calcularMeta(faturamento, metaPrata),
    "#9ca3af",
    metaPrata,
    faturamento
  );

  if(faturamento >= metaPrata){
    criarDonut(
      "metaOuro",
      calcularMeta(faturamento, metaOuro),
      "#d4af37",
      metaOuro,
      faturamento
    );
  }
}



/* ================= DASHBOARD ================= */
function montarDashboard(lista){
  let total = 0;
  const porDia = {};
  const info = {};

  lista.forEach(r=>{
    const v = Number(r.valor) || 0;
    const mod = (r.modalidade || "").toUpperCase();

    if (MODALIDADES_NAO_FINANCEIRAS.some(n => mod.includes(n))) {
      info[r.modalidade] = (info[r.modalidade] || 0) + v;
      return;
    }

    total += v;
    porDia[r.data_lancamento] =
      (porDia[r.data_lancamento] || 0) + v;
  });

  totalEntradas.innerText =
    `R$ ${total.toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2})}`;

  const dias = Object.keys(porDia).length;
  ticketMedio.innerText =
    dias ? `R$ ${(total/dias).toLocaleString("pt-BR",{
      minimumFractionDigits:2,
      maximumFractionDigits:2
    })}` : "R$ 0,00";

  informativas.innerHTML =
    Object.entries(info)
      .map(([m,v])=>`${m}: R$ ${v.toLocaleString("pt-BR",{minimumFractionDigits:2})}`)
      .join("<br>") || "‚Äî";

  if(chart) chart.destroy();
  chart = new Chart(grafico,{
    type:"line",
    data:{
      labels:Object.keys(porDia).map(d=>d.split("-").reverse().join("/")),
      datasets:[{
        data: Object.values(porDia),
        borderColor: "#22c55e",
        backgroundColor: "rgba(34,197,94,.15)",
        tension: .4,
        pointRadius: 5,
        pointHoverRadius: 7,
        pointHitRadius: 20,
        pointBackgroundColor: "#22c55e"
      }]
    },
    options:{plugins:{legend:{display:false}}}
  });

  // üî• ESTA LINHA √â O QUE FALTAVA
renderizarMetas();
}



/* INIT */
carregarEmpresas().then(carregarDados);
</script>

</body>
</html>
