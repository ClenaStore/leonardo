<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">

<title>Financeiro</title>

<meta name="viewport"
      content="width=device-width,
               initial-scale=1,
               maximum-scale=1,
               user-scalable=no,
               viewport-fit=cover">

<!-- PWA / FULLSCREEN -->
<meta name="theme-color" content="#0b0b0b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<link rel="manifest" href="manifest.json">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --gold:#d4af37;
  --bg:#0b0b0b;
  --card:#151515;
  --border:#242424;
  --text:#f5f5f5;
  --muted:#9ca3af;
  --top:56px;
  --bottom:74px;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:Inter}
html,body{width:100%;height:100%;background:var(--bg);color:var(--text);overflow:hidden}

/* TOPBAR */
.topbar{
  position:fixed;top:0;left:0;right:0;
  height:var(--top);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
  background:#0b0b0b;
  border-bottom:1px solid var(--border);
  z-index:10;
}
.topbar h1{
  font-size:16px;
  font-weight:800;
  color:var(--gold);
}

.avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  background:linear-gradient(135deg,#d4af37,#f1d98a);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#000;
  font-weight:800;
  cursor:pointer;
}

/* CONTENT */
.content{
  position:fixed;
  top:var(--top);
  bottom:var(--bottom);
  left:0;
  right:0;
}
iframe{
  width:100%;
  height:100%;
  border:none;
  background:#000;
}

/* NAVBAR */
.navbar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:var(--bottom);
  display:grid;
  grid-template-columns:repeat(5,1fr);
  background:#0b0b0b;
  border-top:1px solid var(--border);
}
.nav-item{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  font-size:11px;
  color:var(--muted);
  cursor:pointer;
}
.nav-item i{font-size:22px}
.nav-item.active{color:var(--gold)}

/* PROFILE */
#profileOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.profile-modal{
  width:90%;
  max-width:360px;
  background:var(--card);
  border-radius:20px;
  padding:20px;
  border:1px solid var(--border);
}
.field{margin-bottom:12px}
.field input{
  width:100%;
  padding:12px;
  border-radius:12px;
  background:#0b0b0b;
  border:1px solid var(--border);
  color:var(--text);
}
.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:999px;
  font-weight:800;
  cursor:pointer;
}
.btn-primary{background:var(--gold);color:#000}
.btn-danger{background:#2a0e0e;color:#f87171}
</style>
</head>

<body>

<!-- TOPBAR -->
<div class="topbar">
  <h1 id="nomeLoja">FINANCEIRO</h1>
  <div class="avatar" id="avatar" onclick="openProfile()">A</div>
</div>

<!-- CONTENT -->
<div class="content">
  <iframe id="frame"></iframe>
</div>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="nav-item active" onclick="go(this,'dashboard.html')">
    <i class="ri-dashboard-line"></i>Dashboard
  </div>
  <div class="nav-item" onclick="go(this,'entradas.html')">
    <i class="ri-arrow-down-circle-line"></i>Entradas
  </div>
  <div class="nav-item" onclick="go(this,'saidas.html')">
    <i class="ri-arrow-up-circle-line"></i>Saídas
  </div>
  <div class="nav-item" onclick="go(this,'relatorios.html')">
    <i class="ri-bar-chart-2-line"></i>Relatórios
  </div>
  <div class="nav-item" onclick="go(this,'config.html')">
    <i class="ri-settings-3-line"></i>Config
  </div>
</nav>

<!-- PROFILE -->
<div id="profileOverlay">
  <div class="profile-modal" onclick="event.stopPropagation()">
    <div class="field">
      <input id="pNome" placeholder="Nome">
    </div>
    <div class="field">
      <input id="pWhats" placeholder="WhatsApp">
    </div>
    <button class="btn btn-primary" onclick="salvarPerfil()">Salvar</button>
    <button class="btn btn-danger" onclick="sair()">Sair</button>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

const frame = document.getElementById("frame");
let user = null;
let perfil = null;
let APP_INICIADO = false;

/* INIT ÚNICO — SEM LOOP */
(async ()=>{
  if (APP_INICIADO) return;
  APP_INICIADO = true;

  const { data:{ session } } = await sb.auth.getSession();
  if (!session) {
    location.href = "index.html";
    return;
  }

  user = session.user;

  const params = new URLSearchParams(location.search);
  let lojaId = params.get("l");

  const { data: perfilDB } = await sb
    .from("clientes_profile")
    .select("*")
    .eq("id", user.id)
    .maybeSingle();

  perfil = perfilDB || (await sb
    .from("clientes_profile")
    .insert({
      id: user.id,
      email: user.email,
      nome: user.email
    })
    .select()
    .single()
  ).data;

  if (!lojaId && perfil.loja_ativa) {
    lojaId = perfil.loja_ativa;
    history.replaceState(null,"",`app.html?l=${lojaId}`);
  }

  const { data: lojaTopo } = await sb
    .from("user_profile")
    .select("negocio")
    .eq("user_id", lojaId)
    .maybeSingle();

  if (lojaTopo?.negocio) {
    nomeLoja.innerText = lojaTopo.negocio;
  }

  // CARREGA IFRAME APENAS UMA VEZ
  frame.src = `dashboard.html?l=${lojaId}`;

  avatar.textContent = (perfil.nome || "A")[0];
  pNome.value = perfil.nome || "";
  pWhats.value = perfil.whatsapp || "";
})();

/* NAVEGAÇÃO SEGURA */
function go(el, page){
  document.querySelectorAll(".nav-item")
    .forEach(i => i.classList.remove("active"));

  el.classList.add("active");

  const lojaId = new URLSearchParams(location.search).get("l");
  const destino = `${page}?l=${lojaId}`;

  if (frame.src.includes(destino)) return;

  frame.src = destino;
}

/* PROFILE */
function openProfile(){
  profileOverlay.style.display = "flex";
}
async function sair(){
  await sb.auth.signOut();
  location.href = "index.html";
}
async function salvarPerfil(){
  await sb.from("clientes_profile").update({
    nome: pNome.value,
    whatsapp: pWhats.value
  }).eq("id", user.id);

  profileOverlay.style.display = "none";
}
</script>

</body>
</html>
