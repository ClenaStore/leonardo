<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Resumo Diário • WhatsApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>

<style>
:root{
  --bg:#0b0b0b;
  --card:#141414;
  --border:#232323;
  --gold:#d4af37;
  --gold-2:#f5d97a;
  --text:#f5f5f5;
  --muted:#9ca3af;
  --radius:16px;
  --radius-sm:12px;
}
*{box-sizing:border-box;font-family:Inter}
html,body{width:100%;overflow-x:hidden}
body{
  margin:0;background:var(--bg);color:var(--text);
  padding:12px 12px 20px;
}
.topo{
  position:sticky;top:0;z-index:10;
  background:rgba(11,11,11,.95);
  backdrop-filter: blur(6px);
  border-bottom:1px solid var(--border);
  padding-bottom:10px;margin-bottom:10px;
}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.header h1{font-size:16px;font-weight:800}
.filtros{display:grid;grid-template-columns:1fr auto;gap:8px}
input,button{
  width:100%;min-height:44px;background:#0f0f0f;border:1px solid var(--border);
  color:#fff;padding:10px 12px;border-radius:12px;font-size:14px
}
button{
  background:linear-gradient(135deg,var(--gold),var(--gold-2));
  color:#000;font-weight:800;border:none
}
.section{margin-bottom:14px}
.section h3{font-size:12px;color:var(--muted);margin:6px 4px 8px}
.card{
  background:linear-gradient(180deg,#171717,#121212);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:12px;margin-bottom:10px
}
.card .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.empresa{font-weight:800;font-size:14px;color:var(--gold);max-width:70%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.total{font-weight:900;font-size:16px}
.linha{display:flex;justify-content:space-between;font-size:13px;padding:4px 0;border-top:1px dashed rgba(255,255,255,.06)}
.muted{color:var(--muted);font-size:13px;text-align:center;padding:16px;border:1px dashed var(--border);border-radius:var(--radius)}
.err{background:#2a0b0b;border:1px solid #7f1d1d;color:#fecaca;padding:10px;border-radius:12px;margin:10px 0;font-size:12px}
</style>
</head>

<body>

<div class="topo">
  <div class="header">
    <h1>Resumo Diário</h1>
  </div>
  <div class="filtros">
    <input type="date" id="data" />
    <button id="btn">Gerar</button>
  </div>
</div>

<div class="section">
  <h3>EMPÓRIO</h3>
  <div id="emporio"></div>
</div>

<div class="section">
  <h3>RESTAURANTE</h3>
  <div id="restaurante"></div>
</div>

<div class="section" id="sec-outros" style="display:none">
  <h3>OUTRAS EMPRESAS</h3>
  <div id="outros"></div>
</div>

<div id="status"></div>

<script>
/* ===== SUPABASE ===== */
const SUPABASE_URL = "https://dxkszikemntfusfyrzos.supabase.co";
const SUPABASE_KEY = "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== FINALIZADORAS ===== */
const categoriasAgrupadas = {
  "Pix": ["pix","qrcode","pix tef","pix cnpj","pix offline"],
  "Crédito": ["credito","cartao credito","credito pos","cart crédito","crédito"],
  "Débito": ["debito","cartao debito","debito pos","cart débito","débito"],
  "Dinheiro": ["dinheiro","pgto online dinheiro"],
  "Voucher": ["voucher","voucher pos","cartao voucher"],
  "Online": ["pagamento online","pagamentos online","online"],
  "Outros": []
};

const BRL = v => Number(v).toLocaleString("pt-BR",{minimumFractionDigits:2});

function normalizarCategoria(mod){
  if(!mod) return "Outros";
  const m = String(mod).toLowerCase();
  for(const [cat,keys] of Object.entries(categoriasAgrupadas)){
    if(keys.some(k => m.includes(k))) return cat;
  }
  return "Outros";
}

/* ===== Separação Empório × Restaurante ===== */
function classificarEmpresa(nome){
  const n = (nome||"").toLowerCase();
  if(n.includes("emp")) return "emporio";
  if(n.includes("rest")) return "restaurante";
  return "outros";
}

/* ===== Carregar ===== */
async function carregar(){
  status.innerHTML = "";
  emporio.innerHTML = restaurante.innerHTML = outros.innerHTML = "";
  sec_outros.style.display = "none";

  const data = document.getElementById("data").value;
  if(!data){
    status.innerHTML = '<div class="err">Selecione uma data.</div>';
    return;
  }

  try{
    const { data: rows, error } = await sb
      .from("resumo_entradas")
      .select("valor, empresa, modalidade")
      .eq("data_lancamento", data);

    if(error) throw error;

    if(!rows || !rows.length){
      emporio.innerHTML = '<div class="muted">Sem vendas no dia selecionado.</div>';
      restaurante.innerHTML = '<div class="muted">Sem vendas no dia selecionado.</div>';
      return;
    }

    const porEmpresa = {};
    rows.forEach(r=>{
      const v = Number(r.valor)||0;
      if(!porEmpresa[r.empresa]) porEmpresa[r.empresa] = { total:0, cats:{} };
      porEmpresa[r.empresa].total += v;
      const cat = normalizarCategoria(r.modalidade);
      porEmpresa[r.empresa].cats[cat] = (porEmpresa[r.empresa].cats[cat]||0) + v;
    });

    Object.entries(porEmpresa).forEach(([empresa,info])=>{
      const linhas = Object.entries(info.cats)
        .sort((a,b)=>b[1]-a[1])
        .map(([c,v])=>`
          <div class="linha">
            <span>• ${c}</span>
            <strong>R$ ${BRL(v)}</strong>
          </div>
        `).join("");

      const bloco = `
        <div class="card">
          <div class="top">
            <div class="empresa" title="${empresa}">${empresa}</div>
            <div class="total">R$ ${BRL(info.total)}</div>
          </div>
          ${linhas}
        </div>
      `;

      const grupo = classificarEmpresa(empresa);
      if(grupo === "emporio") emporio.innerHTML += bloco;
      else if(grupo === "restaurante") restaurante.innerHTML += bloco;
      else{
        sec_outros.style.display = "block";
        outros.innerHTML += bloco;
      }
    });

    if(!emporio.innerHTML) emporio.innerHTML = '<div class="muted">Sem vendas no dia selecionado.</div>';
    if(!restaurante.innerHTML) restaurante.innerHTML = '<div class="muted">Sem vendas no dia selecionado.</div>';

  }catch(err){
    console.error("Erro Supabase:", err);
    status.innerHTML = '<div class="err">Erro ao carregar dados. Veja o console (F12) para detalhes.</div>';
  }
}

/* Eventos */
document.getElementById("btn").addEventListener("click", carregar);
document.getElementById("data").valueAsDate = new Date(); // sugere hoje
</script>

</body>
</html>
